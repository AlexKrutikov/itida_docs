---
title: 'Инструкция по использованию профиля «ФР v5 Атол с платежной системой Сбербанка»'
taxonomy:
    category:
        - docs
    tag:
        - wiki
published: true
---

[h3]
**1.Установка и настройка платежной системы**
[/h3]

1.  Скопировать на жесткий диск следующие файлы: SB_KERNEL.DLL, GATE.DLL, SBRF.DLL, LOADPARM.EXE, RRDK.R, R003.R, PARAMS.TLV
2.  Зарегистрировать библиотеку SBRF.dll с помощью команды (regsvr32 SBRF.dll).
3.  Подключить ПИН-клавиатуру к порту СОМ1 или к USB-порту.
4.  Выполнить загрузку настроечных параметров библиотеки. Для этого запустить программу LOADPARM.EXE, зайти в меню «Служебные операции \ Настройки \ Техобслуживание \ Пароль 878787 \ Загрузка параметров», выбрать файл PARAMS.TLV и дождаться окончания загрузки.
5.  Настроить платежную систему на формирование **одного банковского слипа**. Передать эту информацию сотруднику Сбербанка для внесения изменений по количеству слипов в конфигурацию на сервере (в противном случае информация перезапишется при следующем обновлении). Так же можно сперва попросить сотрудника Сбербанка внести изменения в конфигурацию на сервере с установкой количества слипов равным одному, а затем произвести загрузку параметров для принятия изменений.

[h3]
**2.Настройка оборудования в ПП Айтида**
[/h3]

1.  Установить драйвера ККТ Атол версии 10 (32х разрядные)
2.  Загрузить актуальные профили оборудования с сайта в том числе и профиль «Профиль ФР Атол v.5 (ФН, ФФД 1.05, ДТО 10) с платежной системой СБЕРБАНК»
3.  В режиме расширенного конфигурирования открыть загруженный профиль для редактирования и в модуле «Инициализация ФР» в переменной _КОЛИЧЕСТВОКОПИЙСЛИПА установить необходимое количество слипов для печати. По умолчанию используется 1 (один) слип. Так же с помощью переменной _БАКОВСКИЙСЛИПВМЕСТЕСЧЕКОМ можно установить режим печати слипа вместе с кассовым чеком без отреза (для этого значение переменной должно равняться «true»). Сохранить профиль оборудования, если производилось редактирование указанных выше переменных.
4.  Создать карточку торгового оборудования с типом «Фискальный регистратор»
5.  В поле Профиль выбрать профиль «Профиль ФР Атол v.5 (ФН, ФФД 1.05, ДТО 10) с платежной системой СБЕРБАНК» (см. п. 2 Настройки)
6.  Записать карточку торгового оборудования и открыть заново.
7.  Настроить параметры связи с ККТ нажав на кнопку «Настройки драйвера оборудования»
8.  Заполнить поля в карточке оборудования: «Склад нахождения», «Денежный карман», «Юридическое лицо», «Система налогообложения»
9.  В карточке оборудования установить флаг «Использовать ФР для печати чеков платежной системы»
10.  Добавить подключенный фискальный регистратор в список оборудования в локальном оборудовании (Параметры – Локальное оборудование)

[h3]
**3.Использование (пробитие чеков и сверка итогов)**
[/h3]

При пробитии чеков через Модуль Регистрации Продаж или РМК при наличии оплаты с видом «Безналичные» в чеке сумма безналичной оплаты будет проводиться через подключенный пинпад через платежную систему Сбербанка. После проведения транзакции через платежную систему будет напечатан банковский слип (или слипы), а затем и кассовый чек через подключенный фискальный регистратор.

При закрытии смены на подключенном ФР (снятие Z-отчета) помимо печати кассового отчета будет также произведена операция сверки итогов через платежную систему и печать итогового отчета платежной системы.

[h3]
**4.Механизмы платежной системы, задействованные в профиле.**
[/h3]

В профиле ФР для работы со Сбербанком реализован механизм проведения банковских транзакций с возможностью аварийной отмены.

Сразу после успешного завершения платежа (например, функции «Продажа») транзакция из «нормального» состояния переводится в «неподтвержденное» состояние. В этом состоянии транзакция не включается в контрольную ленту, а при ближайшем сеансе связи с банком (или при закрытии дня) она автоматически отменяется, восстанавливая средства на карте клиента.

После этого профиль приступает к печати чеков и закрытию операции. Если чеки успешно распечатаны и операция корректно закрыта, профиль вызывает функцию подтверждения транзакции. «Подтвержденное» состояние отличается от «нормального» только тем, что в «подтвержденном» состоянии аварийный откат платежа уже невозможен. Подтвержденные транзакции попадают в контрольную ленту и сверку итогов.

Если же профиль убедился, что корректно завершить операцию по кассе невозможно, то вызывается функцию отката транзакции. Эта функция вызывает немедленную отмену платежа (с восстановлением средств на карте клиента) и переводит транзакцию в «отмененное» состояние. Из «отмененного» состояния, как и из «подтвержденного», переход в другие состояния невозможен. Отмененные транзакции не попадают в контрольную ленту и сверку итогов.

В случае, если в процессе закрытия операции программа «зависла» и касса была перезагружена, транзакция остается в «неподтвержденном» состоянии. Это значит, что при любом следующем платеже (неважно, по этой же карте или по другой) она автоматически отменится.
